name: ghc

on:
  push:
    tags:
      - "*"
    branches:
      - release

  pull_request:

jobs:
  init-ghc-haskell:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check-if-skip.outputs.skip }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - id: check-if-skip
        uses: ./.github/actions/check-if-skip
        with:
          checksum-file: checksum/ghc_from_haskell.sha256sum

  build-ghc-haskell:
    runs-on: ubuntu-latest
    needs: init-ghc-haskell
    name: build-ghc-haskell (${{ matrix.platform }}, ${{ matrix.ghc }})
    if: ${{ needs.init-ghc-haskell.outputs.skip == 'false' }}
    strategy:
      matrix:
        # get sha256 from https://downloads.haskell.org/~ghc/$GHC/SHA256SUMS
        include:
          - platform: linux/amd64
            ghc: 8.10.7
            ghc_tar: ghc-8.10.7-x86_64-fedora27-linux.tar.xz
            ghc_sha256: b6ed67049a23054a8042e65c9976d5e196e5ee4e83b29b2ee35c8a22ab1e5b73
            cabal: 3.6.2.0
            cabal_tar: cabal-install-3.6.2.0-x86_64-linux-deb10.tar.xz
            cabal_sha256: 4759b56e9257e02f29fa374a6b25d6cb2f9d80c7e3a55d4f678a8e570925641c
            tag: 8.10.7:8.10

          - platform: linux/arm64
            ghc: 8.10.7
            ghc_tar: ghc-8.10.7-aarch64-deb10-linux.tar.xz
            ghc_sha256: fad2417f9b295233bf8ade79c0e6140896359e87be46cb61cd1d35863d9d0e55
            cabal: 3.6.2.0
            cabal_tar: cabal-install-3.6.2.0-aarch64-linux-deb10.tar.xz
            cabal_sha256: d9acee67d4308bc5c22d27bee034d388cc4192a25deff9e7e491e2396572b030
            tag: 8.10.7:8.10

          - platform: linux/amd64
            ghc: 9.2.5
            ghc_tar: ghc-9.2.5-x86_64-ubuntu20.04-linux.tar.xz
            ghc_sha256: be1ca5b2864880d7c3623c51f2c2ca773e380624929bf0be8cfadbdb7f4b7154
            cabal: 3.6.2.0
            cabal_tar: cabal-install-3.6.2.0-x86_64-linux-deb10.tar.xz
            cabal_sha256: 4759b56e9257e02f29fa374a6b25d6cb2f9d80c7e3a55d4f678a8e570925641c
            tag: 9.2.5:9.2:latest

          - platform: linux/arm64
            ghc: 9.2.5
            ghc_tar: ghc-9.2.5-aarch64-deb10-linux.tar.xz
            ghc_sha256: 29c0735ada90cdbf7e4a227dee08f18d74e33ec05d7c681e4ef95b8aa13104b3
            cabal: 3.6.2.0
            cabal_tar: cabal-install-3.6.2.0-aarch64-linux-deb10.tar.xz
            cabal_sha256: d9acee67d4308bc5c22d27bee034d388cc4192a25deff9e7e491e2396572b030
            tag: 9.2.5:9.2:latest

    steps:
      - uses: actions/checkout@v3

      - name: login to github container registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build
        uses: ./.github/actions/docker-haskell
        with:
          image-name: ghcr.io/hstreamdb/ghc
          dockerfile: dockerfiles/ghc_from_haskell
          platform: ${{ matrix.platform }}
          tag: ${{ matrix.tag }}
          kargs-key: GHC:GHC_TAR:GHC_RELEASE_SHA256:CABAL:CABAL_TAR:CABAL_INSTALL_RELEASE_SHA256
          kargs-value: ${{ matrix.ghc }}:${{ matrix.ghc_tar }}:${{ matrix.ghc_sha256 }}:${{ matrix.cabal }}:${{ matrix.cabal_tar }}:${{ matrix.cabal_sha256 }}

  # ----------------------
# XXX: Unused
#
#  init-ghc-ppa:
#    runs-on: ubuntu-latest
#    outputs:
#      skip: ${{ steps.check-if-skip.outputs.skip }}
#    steps:
#      - uses: actions/checkout@v3
#        with:
#          fetch-depth: 0
#      - id: check-if-skip
#        uses: ./.github/actions/check-if-skip
#        with:
#          checksum-file: checksum/ghc_from_ppa.sha256sum
#
#  build-ghc-ppa:
#    runs-on: ubuntu-latest
#    needs: init-ghc-ppa
#    if: ${{ needs.init-ghc-ppa.outputs.skip == 'false' }}
#    strategy:
#      matrix:
#        # docker_args:docker_tag:[docker_tag_alias...]
#        ghc: ["8.8.4:8.8.4:8.8"]
#        cabal: ["Cabal-v3.6.2.0"]
#    steps:
#      - uses: actions/checkout@v3
#
#      - name: login to github container registry
#        uses: docker/login-action@v1
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: build
#        uses: ./.github/actions/docker-haskell
#        with:
#          image-name: ghcr.io/hstreamdb/ghc
#          dockerfile: dockerfiles/ghc_from_ppa
#          ghc: ${{ matrix.ghc }}
#          cabal: ${{ matrix.cabal }}
#
#  init-ghc-builder:
#    runs-on: ubuntu-latest
#    outputs:
#      skip: ${{ steps.check-if-skip.outputs.skip }}
#    steps:
#      - uses: actions/checkout@v3
#        with:
#          fetch-depth: 0
#      - name: check-if-skip
#        id: check-if-skip
#        uses: ./.github/actions/check-if-skip
#        with:
#          checksum-file: checksum/ghc_builder.sha256sum
#
#  build-ghc-builder:
#    runs-on: ubuntu-latest
#    needs: init-ghc-builder
#    if: ${{ needs.init-ghc-builder.outputs.skip == 'false' }}
#    strategy:
#      matrix:
#        # git_tag:docker_tag:[docker_tag_alias...]
#        ghc: ["ghc-8.10.7-release:ghc-8.10.7:8.10.7:8.10", "ghc-9.2.1-release:ghc-9.2.1:9.2.1:9.2"]
#        cabal: ["Cabal-v3.6.2.0:cabal-3.6.2"]
#        include:
#          - ghc: ghc-8.10.7-release:ghc-8.10.7:8.10.7:8.10
#            cabal: Cabal-v3.6.2.0:cabal-3.6.2
#            ghc_base: 8.10.4
#          - ghc: ghc-9.2.1-release:ghc-9.2.1:9.2.1:9.2
#            cabal: Cabal-v3.6.2.0:cabal-3.6.2
#            ghc_base: 8.10.4
#    steps:
#      - uses: actions/checkout@v3
#
#      - name: login to github container registry
#        uses: docker/login-action@v1
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: build ghc-builder
#        uses: ./.github/actions/docker-haskell
#        with:
#          image-name: ghcr.io/hstreamdb/ghc-builder
#          dockerfile: dockerfiles/ghc-builder
#          ghc: ${{ matrix.ghc }}
#          cabal: ${{ matrix.cabal }}
#          kargs-key: BASE_GHC
#          kargs-value: ${{ matrix.ghc_base }}
#
#  init-ghc-src:
#    runs-on: ubuntu-latest
#    outputs:
#      skip: ${{ steps.check-if-skip.outputs.skip }}
#    steps:
#      - uses: actions/checkout@v3
#        with:
#          fetch-depth: 0
#      - id: check-if-skip
#        uses: ./.github/actions/check-if-skip
#        with:
#          checksum-file: checksum/ghc.sha256sum
#
#  build-ghc-src:
#    runs-on: ubuntu-latest
#    needs: init-ghc-src
#    if: ${{ needs.init-ghc-src.outputs.skip == 'false' }}
#    strategy:
#      matrix:
#        # docker_args:docker_tag:[docker_tag_alias...]
#        ghc: ["9.2.1:9.2.1:9.2"]
#    steps:
#      - uses: actions/checkout@v3
#
#      - name: login to github container registry
#        uses: docker/login-action@v1
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: build
#        uses: ./.github/actions/docker-haskell
#        with:
#          image-name: ghcr.io/hstreamdb/ghc
#          dockerfile: dockerfiles/ghc
#          ghc: ${{ matrix.ghc }}
#          cabal: ""
